---
import { getCollection } from "astro:content";
import { get, uniq, flatMap, map } from "lodash-es";
import Posts from "../../layouts/Posts.astro";
import Pagination from "../../layouts/Pagination.astro";
import { sortByDate } from "../../utils/posts";
import Layout from "../../layouts/Layout.astro";

export async function getStaticPaths({ paginate }: any) {
  const allPosts = await getCollection("blog");
  const sorted = sortByDate(allPosts);

  return paginate(sorted, {
    pageSize: 6,
  });
}

const { page } = Astro.props as { page: any };

const allPosts = await getCollection("blog");
const categories = uniq(flatMap(allPosts, (post) => get(post, ["data", "categories"], [])));
---

<Layout>
  <div class="categories">
    {
      map(categories, (category) => (
        <a class="category" href={`/blog/${category}`}>
          {category}
        </a>
      ))
    }
  </div>
  <Posts posts={page?.data} />
  <Pagination
    prevUrl={page.url.prev}
    nextUrl={page.url.next}
    currentPage={page.currentPage}
    totalPages={page.lastPage}
    paged="blog"
  />
</Layout>

<style>
  .categories {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: flex-start;
    margin-bottom: 2rem;
    border-bottom: 1px solid currentColor;
  }

  .category {
    color: var(--text-color);
    font-weight: bold;
    text-transform: capitalize;

    &:hover {
      color: var(--secondary);
    }
  }
</style>
